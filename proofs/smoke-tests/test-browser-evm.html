<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrowserEVM Test</title>
</head>
<body>
  <h1>BrowserEVM Test - Depository.sol</h1>
  <div id="status">Initializing...</div>
  <pre id="log"></pre>

  <script type="module">
    import { createVM, runTx } from '/node_modules/@ethereumjs/vm/dist/esm/index.js';
    import { createLegacyTx } from '/node_modules/@ethereumjs/tx/dist/esm/index.js';
    import { createAddressFromPrivateKey, hexToBytes, createAccount } from '/node_modules/@ethereumjs/util/dist/esm/index.js';

    const status = document.getElementById('status');
    const log = document.getElementById('log');

    function appendLog(msg) {
      log.textContent += msg + '\n';
      console.log(msg);
    }

    try {
      status.textContent = 'Loading contract artifact...';
      const response = await fetch('/contracts/artifacts/contracts/Depository.sol/Depository.json');
      const artifact = await response.json();
      const bytecode = artifact.bytecode;

      appendLog(`[OK] Loaded Depository.sol (${bytecode.length / 2} bytes)`);

      status.textContent = 'Creating EVM...';
      const vm = await createVM();
      const common = vm.common;

      appendLog('[OK] Created EthereumJS VM');

      // Deployer account
      const deployerPrivKey = hexToBytes('0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80');
      const deployerAddress = createAddressFromPrivateKey(deployerPrivKey);
      const deployerAccount = createAccount({
        nonce: 0n,
        balance: 10000000000000000000000n,
      });
      await vm.stateManager.putAccount(deployerAddress, deployerAccount);

      appendLog(`[OK] Funded deployer: ${deployerAddress.toString()}`);

      // Deploy contract
      status.textContent = 'Deploying contract...';
      const deployTx = createLegacyTx({
        gasLimit: 100000000n,
        gasPrice: 10n,
        data: bytecode,
      }, { common }).sign(deployerPrivKey);

      const deployResult = await runTx(vm, { tx: deployTx });

      if (deployResult.execResult.exceptionError) {
        throw new Error(`Deployment failed: ${deployResult.execResult.exceptionError}`);
      }

      const contractAddress = deployResult.createdAddress;
      appendLog(`[OK] Deployed at: ${contractAddress.toString()}`);
      appendLog(`   Gas used: ${deployResult.totalGasSpent}`);

      // Call debugFundReserves
      status.textContent = 'Calling debugFundReserves...';
      const selector = '0x5ffefe5b';
      const entityId = '0x0000000000000000000000000000000000000000000000000000000000000001';
      const tokenId = '0x0000000000000000000000000000000000000000000000000000000000000001';
      const amount = '00000000000000000000000000000000000000000000003635c9adc5dea00000';
      const callData = selector + entityId.slice(2) + tokenId.slice(2) + amount;

      const callTx = createLegacyTx({
        to: contractAddress,
        gasLimit: 1000000n,
        gasPrice: 10n,
        data: callData,
        nonce: 1n,
      }, { common }).sign(deployerPrivKey);

      const callResult = await runTx(vm, { tx: callTx });

      if (callResult.execResult.exceptionError) {
        throw new Error(`Call failed: ${callResult.execResult.exceptionError}`);
      }

      appendLog(`[OK] Transaction executed`);
      appendLog(`   Gas used: ${callResult.totalGasSpent}`);
      appendLog(`   Logs emitted: ${callResult.execResult.logs?.length || 0}`);

      status.textContent = '[OK] SUCCESS! EthereumJS VM works in browser.';
      status.style.color = 'green';
      status.style.fontWeight = 'bold';

    } catch (error) {
      status.textContent = `[X] FAILED: ${error.message}`;
      status.style.color = 'red';
      appendLog(`[X] Error: ${error.message}`);
      console.error(error);
    }
  </script>
</body>
</html>
